trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageName: 'metaflow-app'
  acrName: 'metaflowacrrm557702'
  resourceGroup: 'MetaFlowGroup'

steps:
- task: Gradle@3
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.21'
    jdkArchitectureOption: 'x64'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    tasks: 'build'

- task: PublishTestResults@2
  inputs:
    testRunner: 'JUnit'
    testResultsFiles: '**/build/test-results/test/**/TEST-*.xml'
    testRunTitle: 'Testes Unit√°rios - $(Build.BuildId)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(System.DefaultWorkingDirectory)/build/libs'
    ArtifactName: 'app-artifact'
    publishLocation: 'Container'

- task: Docker@2
  inputs:
    containerRegistry: '$(acrName)-connection'
    repository: '$(imageName)'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: 'latest'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'Azure-Connection'
    scriptType: 'bash'
    scriptLocation: 'scriptPath'
    scriptPath: 'scripts/script-deploy-aci.sh'